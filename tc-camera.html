<!DOCTYPE html>
<html>
    <head>
        <title>
            tc-camera
        </title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="http://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
        <script src="js/megapix-image.js" type="text/javascript"></script>
    </head>
    <body>

        <div>
            <button style="width:60px;" id="fileSelect">upload</button> 
            <input type="file" id="input" name="input" accept="image/*" style="display:block;">
        </div>
        <div>
            <canvas id="camera-canvas" name="camera-canvas" width="500" height="500"></canvas> 
            <img id="img" src="" style="visibility:hidden">
            <button id="sendStatement" type="button">Send Statement</button>
        </div>

        <script type="text/javascript">
        $(document).ready(function() {
        var scale = 0.1;

        var canvas = $('#camera-canvas')[0];
        var ctx = canvas.getContext("2d");

        var fileSelect = document.getElementById("fileSelect"),
        input = document.getElementById("input");

        input.addEventListener("change", handleFiles);

        //hides ugly default file input button  
        fileSelect.addEventListener("click", function (e) {
        if (input) {
            input.click();
        }
        e.preventDefault();
        }, false);

        var imageData;
        var reader = new FileReader();

        function handleFiles(e) {
        
        reader.onload = function (event) {
            alert('reader loaded');
            console.log(reader);
            imageData = reader.result;
            console.log(typeof(reader.result));
            var resultImage = MegaPixImage(reader.result);
            
        var img = $('#img')[0];
        // img.id = "input-image";
        img.src = reader.result;
        img.addEventListener('load', function(){
            imgWidth = img.offsetWidth,
            imgHeight = img.offsetHeight;
            //canvas.width = imgWidth;
            //canvas.height = imgHeight;
            console.log(canvas);
            new MegaPixImage(img).render(canvas, { width: imgWidth * scale, height: imgHeight * scale });
            
          }, false);
        //     //loadImageToCanvas();

        //     var maxWidth = 200;
        //     var maxHeight = 200;
        //     imageWidth = img.width,
        //     imageHeight = img.height;

        //     if (imageWidth > imageHeight) {
        //         if (imageWidth > maxWidth) {
        //             imageHeight *= maxWidth / imageWidth;
        //             imageWidth = maxWidth;
        //         }
        //     } else {
        //         if (imageHeight > maxHeight) {
        //             imageWidth *= maxHeight / imageHeight;
        //             imageHeight = maxHeight;
        //         }
        //     }

     
        //     // alert(canvas.width + ' - ' + canvas.height);

        //     // ctx.drawImage(this, 0, 0, imageWidth, imageHeight);
            

        //     // // The resized file ready for upload
        //     //console.log(canvas.toDataURL());
        //     //generateStatement();
        //     // var postData = 'canvasData=' + finalFile;
        //     // var ajax = new XMLHttpRequest();
        //     // ajax.open('POST', 'save.php', true);
        //     // ajax.setRequestHeader('Content-Type', 'canvas/upload');

        //     // ajax.onreadystatechange = function () {
        //     //     if (ajax.readyState == 4) {
        //     //         //just to visually confirm it worked...
        //     //         window.open(canvas.toDataURL("image/png"), "mywindow");
        //     //     }
        //     // }
        //     // ajax.send(postData);
        // }
        }
        reader.readAsDataURL(e.target.files[0]);
        }

        function loadImageToCanvas(){
            console.log($('#input-image'));
            imageData = canvas.toDataURL();
            console.log(imageData);
        }

        $('#sendStatement').click(function(){
            console.log('sending statement');
        generateStatement(function(){
        alert('statement saved');
        });
        });

        function generateStatement(callback){
        var drawing = {}
        // drawing.x = clickX;
        // drawing.y = clickY;
        // drawing.drag = clickDrag;
        drawing.base64data = canvas.toDataURL();
        drawing.width = canvas.width;
        drawing.height = canvas.height;

        console.log(JSON.stringify(drawing));

        var s = {};
        s.actor = {};
        s.actor['name'] = "Brian Rogers";
        s.actor['mbox'] = "mailto:brian.rogers@scorm.com";
        s.actor['objectType'] = 'Agent';

        s.verb = {};
        s.verb['display'] = {'en-US':'drew'};
        s.verb['id'] = 'http://scorm.com/verbs/drew';

        s["object"] = {};
        s["object"].definition = {};
        s["object"].definition.name = {'en-US':'tcdraw'};
        s["object"].id = 'http://scorm.com/tc-camera-d9999462-2505-4e60-b905-aa69ccc1c250';
        s["object"].type = "Activity";

        s.context = {};
        s.context.extensions = {};
        s.context.extensions["http://scorm.com/extensions/tc-camera-data"] = drawing;

        putStatement(s, function(data){
        console.log(data);
        callback(data);
        });

        }

        function putStatement(statement, callback){
        console.log(JSON.stringify(statement));

        $.ajax({
        url: 'https://cloud.scorm.com/ScormEngineInterface/TCAPI/public/statements',
        type: 'POST',
        dataType: 'json',
        data: JSON.stringify(statement),
        contentType: 'application/json',
        success: function(data) {
        //console.log(data); 
        callback(data);
        },
        error: function(err) {
        console.log(err);
        alert('error:'+err.status+' - '+err.statusText);

        },
        beforeSend: function(xhr) {
        xhr.setRequestHeader('Authorization', 'Basic VGVzdDpWR1Z6ZEZWelpYSTZjR0Z6YzNkdmNtUT0=');
        xhr.setRequestHeader('X-Experience-API-Version','0.95');
        }
        });
        }

        function GUID ()
        {
        var S4 = function ()
        {
        return Math.floor(
                Math.random() * 0x10000 /* 65536 */
            ).toString(16);
        };

        return (
            S4() + S4() + "-" +
            S4() + "-" +
            S4() + "-" +
            S4() + "-" +
            S4() + S4() + S4()
        );
        }
        });
        </script>
    </body>
</html>